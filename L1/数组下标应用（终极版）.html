<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数组储物柜探秘</title>
    <!-- 引入 canvas-confetti 库 -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Verdana', sans-serif;
            background: linear-gradient(135deg, #e0f2f1, #b2dfdb);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            color: #263238;
            text-align: center;
            overflow: hidden;
        }

        #game-container {
            background-color: rgba(255, 255, 255, 0.97);
            padding: 30px;
            border-radius: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1), 0 5px 15px rgba(0,0,0,0.05);
            width: 90%;
            max-width: 850px;
            position: relative; 
            overflow: hidden; 
        }

        header h1 {
            color: #00796b;
            margin-bottom: 20px;
            font-size: 2.2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        #story-area {
            font-size: 1.15em;
            margin-bottom: 25px;
            color: #004d40;
            line-height: 1.7;
        }

        #question-area {
            font-size: 1.35em;
            font-weight: bold;
            margin-bottom: 30px;
            color: #c62828;
            min-height: 65px;
            padding: 12px 18px;
            background-color: #fff8e1;
            border-radius: 12px;
            border-left: 6px solid #ff8f00;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .keyword {
            color: #0277bd;
            font-weight: bold;
            padding: 1px 3px;
            background-color: rgba(2, 119, 189, 0.08);
            border-radius: 3px;
        }
        .value-keyword {
            color: #2e7d32;
            font-weight: bold;
            padding: 1px 3px;
            background-color: rgba(46, 125, 50, 0.08);
            border-radius: 3px;
        }

        #array-display-wrapper {
            position: relative;
            margin-bottom: 35px;
            min-height: 230px; 
        }

        /* --- 3D Cabinet Styles --- */
        #array-display {
            display: flex;
            justify-content: center;
            align-items: center; /* Centering vertically */
            padding-top: 25px;
            padding-bottom: 25px;
            gap: 25px; 
            /* [MODIFIED] Set up the 3D space, but don't transform the container itself */
            perspective: 1200px;
        }

        .cabinet-compartment {
            width: 120px;  
            height: 170px; 
            background: linear-gradient(145deg, #CFD8DC, #90A4AE); 
            border: 1px solid #546E7A;
            border-top-color: #ECEFF1;
            border-left-color: #CFD8DC;
            border-radius: 10px; 
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.25),
                        inset 3px 3px 5px rgba(0,0,0,0.25), 
                        inset -2px -2px 3px rgba(255,255,255,0.1); 
            display: flex;
            flex-direction: column;
            justify-content: space-evenly; 
            align-items: center;
            padding: 10px 0; 
            box-sizing: border-box; 
            transform-style: preserve-3d;
            /* [MODIFIED] New transform strategy: Only rotate on X-axis for a non-skewed tilt */
            transform: rotateX(15deg);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                        box-shadow 0.4s ease;
        }

        /* [MODIFIED] Hover effect now builds upon the new base transform */
        .cabinet-compartment:hover, .cabinet-compartment.child-hover-active {
            transform: rotateX(5deg) scale(1.1) translateZ(30px);
            box-shadow: 0 18px 35px rgba(0,0,0,0.35),
                        inset 2px 2px 4px rgba(0,0,0,0.2),
                        inset -1px -1px 2px rgba(255,255,255,0.05);
            z-index: 10;
        }

        .index-label {
            position: relative; 
            transform: translateZ(5px); 
            background-image: linear-gradient(to bottom, #26a69a, #00897b); 
            color: #FFFFFF; 
            text-shadow: 0 -1px 0px rgba(0,0,0,0.4); 
            padding: 5px 12px; 
            border-radius: 5px; 
            font-size: 0.9em; 
            font-weight: 700; 
            border: 1px solid #004d40; 
            box-shadow: 0 2px 3px rgba(0,0,0,0.5), 
                        0 0 0 1px rgba(255,255,255,0.15) inset;
            min-width: 60px;
            text-align: center;
            z-index: 15;
            cursor: pointer;
            transition: transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.25s ease-out, background-image 0.25s ease;
        }
        .index-label::before { 
            content: "下标 "; 
            font-weight: 400; 
            opacity: 0.8;
        }

        .index-label:hover {
            transform: translateZ(10px) scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            background-image: linear-gradient(to bottom, #4db6ac, #26a69a);
        }

        .value-box {
            width: 85px;  
            height: 70px; 
            background-image: linear-gradient(to bottom, #FFF3E0, #FFE0B2); 
            border: 1px solid #FFCC80; 
            border-bottom: 3px solid #FFA726; 
            border-radius: 8px; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em; 
            font-weight: bold;
            color: #A1887F; 
            text-shadow: 1px 1px 0px rgba(255,255,255,0.6);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15), inset 0 0 10px rgba(0,0,0,0.05);
            position: relative;
            transform: translateZ(15px); 
            z-index: 5;
            cursor: pointer;
            transition: transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.25s ease-out;
        }

        .value-box:hover {
            transform: translateZ(25px) scale(1.15); 
            box-shadow: 0 8px 18px rgba(0,0,0,0.3);
            z-index: 20;
            background-image: linear-gradient(to bottom, #FFF8E1, #FFECB3); 
        }

        .value-box.eaten {
            animation: item-selected-animation 0.8s forwards;
        }

        @keyframes item-selected-animation {
            0% { transform: scale(1) rotate(0deg) translateZ(15px); opacity: 1; }
            20% { transform: scale(1.15) rotate(-3deg) translateZ(25px); opacity: 0.9; } 
            40% { transform: scale(1.1) rotate(3deg) translateZ(20px) translateY(-10px); opacity: 0.8; } 
            100% { transform: scale(0.7) translateY(-60px) rotate(15deg) translateZ(-20px); opacity: 0; } 
        }
        /* --- End of 3D Cabinet Styles --- */

        #feedback-area { font-size: 1.3em; min-height: 45px; margin-top: 15px; margin-bottom: 25px; font-weight: bold; padding: 10px 15px; border-radius: 10px; }
        .correct-feedback { color: #1D6F42; background-color: #d1f7e0; border: 2px solid #77dd77; box-shadow: 0 0 10px rgba(119, 221, 119, 0.5); }
        .incorrect-feedback { color: #A83C32; background-color: #fddbd0; border: 2px solid #ff6961; box-shadow: 0 0 10px rgba(255, 105, 97, 0.5); }

        /* === LEVEL PROGRESS BAR STYLES === */
        #level-progress-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-top: 1px solid #b2dfdb;
            margin-top: 10px;
        }
        .level-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #78909C;
            background-color: #ECEFF1;
            color: #546E7A;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .level-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .level-button.completed-level {
            background-color: #4CAF50;
            border-color: #388E3C;
            color: white;
            font-size: 1.5em; 
        }
        .level-button.current-level {
            background-color: #009688;
            border-color: #00796b;
            color: white;
            transform: scale(1.15);
            box-shadow: 0 0 15px rgba(0, 150, 136, 0.6);
        }
        
        #guidance-area { display: none; position: absolute; bottom: -65px; left: 50%; transform: translateX(-50%) translateY(20px); min-width: 280px; max-width: 420px; background-color: #fff3cd; color: #664d03; border: 2px solid #ffc107; border-radius: 15px; padding: 15px 20px; font-size: 1.05em; line-height: 1.5; box-shadow: 0 5px 15px rgba(0,0,0,0.15); z-index: 100; opacity: 0; transition: opacity 0.3s ease-out, transform 0.3s ease-out; cursor: pointer; }
        #guidance-area::after { content: ""; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); border-width: 10px; border-style: solid; border-color: transparent transparent #ffc107 transparent; }
        #guidance-area.visible { display: block; opacity: 1; transform: translateX(-50%) translateY(0); }

        button:disabled { background-image: linear-gradient(to bottom, #cccccc, #999999) !important; cursor: not-allowed !important; transform: translateY(0) scale(1) !important; box-shadow: 0 2px 3px rgba(0,0,0,0.05) !important; }

        .highlight-correct { box-shadow: 0 0 25px 10px #4CAF50, 0 0 10px 3px #81C784 inset !important; border: 3px solid #388E3C !important; transform: rotateX(5deg) scale(1.15) translateZ(10px) !important; }
        .highlight-error-attempt { box-shadow: 0 0 20px 7px #F44336, 0 0 8px 2px #E57373 inset !important; transform: rotateX(10deg) scale(1.08) translateZ(5px) !important; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: linear-gradient(135deg, #ffffff, #e8eaf6); margin: auto; padding: 35px 40px; border: none; width: 90%; max-width: 550px; border-radius: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: zoomInEffect 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; }
        @keyframes zoomInEffect { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        .modal-content h2 { font-size: 2.8em; color: #00796b; margin-bottom: 15px; text-shadow: 0 0 10px rgba(0, 121, 107, 0.3); animation: titleGlow 1.5s infinite alternate ease-in-out; }
        @keyframes titleGlow { from { text-shadow: 0 0 5px rgba(0,121,107,0.2), 0 0 10px rgba(0,121,107,0.2); } to { text-shadow: 0 0 15px rgba(0,121,107,0.5), 0 0 25px rgba(0,121,107,0.5); } }
        .modal-content p { font-size: 1.3em; margin-bottom: 25px; color: #37474f; }
        .close-button { background-color: #e57373; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 20px; font-weight: bold; position: absolute; top: -15px; right: -15px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background-color 0.2s, transform 0.2s; display: flex; align-items: center; justify-content: center; }
        .close-button:hover { background-color: #ef5350; transform: scale(1.1); }

        #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: -1; }
        .confetto { position: absolute; width: 10px; height: 10px; background-color: red; opacity: 0; animation: fall 3s linear infinite; }
        @keyframes fall { 0% { transform: translateY(-20vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(120vh) rotate(720deg); opacity: 0; } }
    </style>
</head>
<body>

    <div id="game-container">
        <header>
            <h1>数组储物柜探秘</h1>
        </header>
        <div id="story-area">
            欢迎来到数组储物柜！这里有一排神奇的储物格，每个格子上都标有 <span class="keyword">下标</span> (位置编号，从0开始)，格子里放着一个写有数字的 <span class="value-keyword">盒子</span> (代表元素值)。柜子里的盒子每次都会不一样哦！
        </div>

        <div id="question-area"></div>
        <div id="array-display-wrapper">
            <div id="array-display"></div>
            <div id="guidance-area">
            </div>
        </div>

        <div id="feedback-area"></div>
        
        <div id="level-progress-container"></div>
    </div>

    <div id="win-modal" class="modal">
        <div class="modal-content">
            <div id="confetti-canvas"></div>
            <button class="close-button" onclick="closeWinModal()">&times;</button>
            <h2>🏆 完美通关! 🏆</h2>
            <p>你已经彻底掌握了数组储物柜的秘密，<br>能准确区分 <span class="keyword">下标</span> 和 <span class="value-keyword">盒子里的数字</span>！<br>你真是个编程小能手！</p>
        </div>
    </div>

    <script>
        // JavaScript 部分完全无需改动，因此保持原样
        const levelTemplates = [
            { id: 1, arrayLength: 5, valueRange: { min: 1, max: 15 }, taskType: 'findByIndex_clickElement', getQuestion: (targetIndex, array) => `请找到放在 <span class="keyword">下标 ${targetIndex}</span> 位置储物格里的盒子。点击那个<span class="value-keyword">盒子</span>！`, },
            { id: 2, arrayLength: 5, valueRange: { min: 1, max: 20 }, taskType: 'findByElement_clickIndex', getQuestion: (targetValue, array) => `哪个储物格里的<span class="value-keyword">盒子</span>上写着数字 <span class="value-keyword">${targetValue}</span>？它在哪个 <span class="keyword">下标</span> 呢？请点击对应的<span class="keyword">下标标签</span>！`, },
            { id: 3, arrayLength: 5, valueRange: { min: 0, max: 10 }, targetN: 3, taskType: 'findNthElement_clickElement', getQuestion: (targetN, array) => `请找出从左边数 <span class="keyword">第 ${targetN} 个</span> 储物格里的<span class="value-keyword">盒子</span> (记住，第1个格子的<span class="keyword">下标</span>是0哦！)。点击那个<span class="value-keyword">盒子</span>！`, },
            { id: 4, arrayLength: 6, valueRange: { min: 10, max: 99 }, taskType: 'findByElement_clickIndex', getQuestion: (targetValue, array) => `哪个储物格里的<span class="value-keyword">盒子</span>上写着数字 <span class="value-keyword">${targetValue}</span>？请点击它的 <span class="keyword">下标标签</span>。`, },
            { id: 5, arrayLength: 4, valueRange: { min: 1, max: 10 }, targetIndexForTask: 0, taskType: 'findByIndex_clickElement', getQuestion: (targetIndex, array) => `请找到 <span class="keyword">下标为 ${targetIndex}</span> 的储物格里的<span class="value-keyword">盒子</span>，也就是第一个格子里的盒子。点它！`, },
            { id: 6, arrayLength: 4, valueRange: { min: 5, max: 25 }, targetN: 1, taskType: 'findNthElement_clickIndex', getQuestion: (targetN, array) => `请点击 <span class="keyword">第 ${targetN} 个</span> 储物格对应的 <span class="keyword">下标标签</span>。`, }
        ];
        
        const confettiColorsList = [
            ['#ff9a9e', '#fad0c4'],
            ['#a18cd1', '#fbc2eb'],
            ['#fbc2eb', '#a6c1ee'],
            ['#84fab0', '#8fd3f4'],
            ['#fccb90', '#d57eeb']
        ];

        let currentLevelIndex = 0;
        let currentLevelData = {};
        let gameActive = true;

        const questionArea = document.getElementById('question-area');
        const arrayDisplay = document.getElementById('array-display');
        const feedbackArea = document.getElementById('feedback-area');
        const guidanceArea = document.getElementById('guidance-area');
        const winModal = document.getElementById('win-modal');
        const confettiCanvas = document.getElementById('confetti-canvas');
        const levelProgressContainer = document.getElementById('level-progress-container');

        function generateRandomArray(length, range) {
            const rangeSize = range.max - range.min + 1;
            if (length > rangeSize) {
                const fallbackArr = [];
                for (let i = 0; i < length; i++) { fallbackArr.push(Math.floor(Math.random() * (range.max - range.min + 1)) + range.min); }
                return fallbackArr;
            }
            const uniqueNumbers = new Set();
            while (uniqueNumbers.size < length) { uniqueNumbers.add(Math.floor(Math.random() * (range.max - range.min + 1)) + range.min); }
            return Array.from(uniqueNumbers);
        }

        function prepareLevelData(levelTemplate) {
            const data = { ...levelTemplate };
            data.array = generateRandomArray(levelTemplate.arrayLength, levelTemplate.valueRange);

            if (levelTemplate.taskType === 'findByIndex_clickElement') {
                data.targetIndex = typeof levelTemplate.targetIndexForTask !== 'undefined' ? levelTemplate.targetIndexForTask : Math.floor(Math.random() * data.array.length);
                data.questionText = levelTemplate.getQuestion(data.targetIndex, data.array);
            } else if (levelTemplate.taskType === 'findByElement_clickIndex') {
                 if (data.array.length === 0) {
                    data.targetValue = levelTemplate.valueRange.min; data.correctIndexForTask = -1; 
                } else {
                    data.targetValue = data.array[Math.floor(Math.random() * data.array.length)];
                    data.correctIndexForTask = data.array.indexOf(data.targetValue);
                }
                data.questionText = levelTemplate.getQuestion(data.targetValue, data.array);
            } else if (levelTemplate.taskType === 'findNthElement_clickElement') {
                data.targetN = levelTemplate.targetN;
                data.questionText = levelTemplate.getQuestion(data.targetN, data.array);
                data.correctIndexForTask = data.targetN - 1;
            } else if (levelTemplate.taskType === 'findNthElement_clickIndex') {
                data.targetN = levelTemplate.targetN;
                data.questionText = levelTemplate.getQuestion(data.targetN, data.array);
                data.correctIndexForTask = data.targetN - 1;
            }
            return data;
        }
        
        function renderLevelButtons() {
            levelProgressContainer.innerHTML = '';
            levelTemplates.forEach((level, index) => {
                const button = document.createElement('button');
                button.className = 'level-button';
                
                if (index < currentLevelIndex) {
                    button.classList.add('completed-level');
                    button.innerHTML = '&#10003;'; 
                } else if (index === currentLevelIndex) {
                    button.classList.add('current-level');
                    button.textContent = index + 1;
                } else {
                    button.textContent = index + 1;
                }

                button.addEventListener('click', () => {
                    loadLevel(index);
                });
                levelProgressContainer.appendChild(button);
            });
        }

        function resetHighlights() {
            document.querySelectorAll('.cabinet-compartment.child-hover-active').forEach(el => el.classList.remove('child-hover-active'));
            document.querySelectorAll('.highlight-correct, .highlight-error-attempt').forEach(el => el.classList.remove('highlight-correct', 'highlight-error-attempt'));
        }

        function loadLevel(levelIdx) {
            currentLevelIndex = levelIdx;
            currentLevelData = prepareLevelData(levelTemplates[currentLevelIndex]);
            gameActive = true;

            questionArea.innerHTML = currentLevelData.questionText;
            arrayDisplay.innerHTML = '';
            feedbackArea.textContent = '';
            feedbackArea.className = '';
            guidanceArea.classList.remove('visible');
            resetHighlights();
            renderLevelButtons();

            currentLevelData.array.forEach((element, index) => {
                const cabinetCompartment = document.createElement('div');
                cabinetCompartment.className = 'cabinet-compartment';

                const valueBox = document.createElement('div');
                valueBox.className = 'value-box';
                valueBox.textContent = element;
                valueBox.dataset.value = element;

                const indexLabel = document.createElement('div');
                indexLabel.className = 'index-label';
                indexLabel.textContent = index;
                indexLabel.dataset.index = index;

                [valueBox, indexLabel].forEach(interactiveEl => {
                    interactiveEl.addEventListener('mouseenter', () => { if (gameActive) cabinetCompartment.classList.add('child-hover-active'); });
                    interactiveEl.addEventListener('mouseleave', () => { cabinetCompartment.classList.remove('child-hover-active'); });
                    if (interactiveEl === valueBox) { interactiveEl.addEventListener('click', (e) => handleInteraction(e, valueBox, 'element', index, element)); } 
                    else { interactiveEl.addEventListener('click', (e) => handleInteraction(e, indexLabel, 'index', index, element)); }
                });

                cabinetCompartment.appendChild(valueBox);
                cabinetCompartment.appendChild(indexLabel);
                arrayDisplay.appendChild(cabinetCompartment);
            });
        }

        function handleInteraction(event, clickedElement, clickedType, itemIndex, itemValue) {
            if (!gameActive) return;

            guidanceArea.classList.remove('visible');
            resetHighlights();

            const { taskType, array } = currentLevelData;
            let correct = false;
            let correctTargetDescription = "";
            let userClickDescription = "";
            let correctDOMElementToHighlight;

            if (taskType === 'findByIndex_clickElement') {
                const targetIdx = currentLevelData.targetIndex;
                correct = (clickedType === 'element' && itemIndex === targetIdx);
                userClickDescription = `你点击了位于<span class="keyword">下标 ${itemIndex}</span> 的<span class="value-keyword">盒子</span> (数字: <span class="value-keyword">${itemValue}</span>)`;
                correctTargetDescription = `应该点击位于 <span class="keyword">下标 ${targetIdx}</span> 的<span class="value-keyword">盒子</span> (数字: <span class="value-keyword">${array[targetIdx]}</span>)。`;
                if (arrayDisplay.children[targetIdx]) { correctDOMElementToHighlight = arrayDisplay.children[targetIdx].querySelector('.value-box'); }
            } else if (taskType === 'findByElement_clickIndex') {
                const targetVal = currentLevelData.targetValue;
                const correctIdx = currentLevelData.correctIndexForTask;
                correct = (clickedType === 'index' && itemIndex === correctIdx);
                userClickDescription = `你点击了 <span class="keyword">下标 ${itemIndex}</span> (对应盒子数字 <span class="value-keyword">${array[itemIndex]}</span>)`;
                 if (clickedType === 'element') { userClickDescription = `你点击了<span class="value-keyword">盒子</span> (数字 <span class="value-keyword">${itemValue}</span>，位于<span class="keyword">下标 ${itemIndex}</span>)，但题目要求点击<span class="keyword">下标标签</span>。`; }
                correctTargetDescription = `写有数字 <span class="value-keyword">${targetVal}</span> 的<span class="value-keyword">盒子</span>位于 <span class="keyword">下标 ${correctIdx}</span>。应该点击那个<span class="keyword">下标标签</span>。`;
                 if (correctIdx !== -1 && arrayDisplay.children[correctIdx]) { correctDOMElementToHighlight = arrayDisplay.children[correctIdx].querySelector('.index-label'); }
            } else if (taskType === 'findNthElement_clickElement') {
                const correctIdx = currentLevelData.correctIndexForTask;
                correct = (clickedType === 'element' && itemIndex === correctIdx);
                userClickDescription = `你点击了位于<span class="keyword">下标 ${itemIndex}</span> 的<span class="value-keyword">盒子</span> (数字: <span class="value-keyword">${itemValue}</span>)。这是第 <span class="keyword">${itemIndex + 1}</span> 个格子里的盒子。`;
                correctTargetDescription = `要找的是 <span class="keyword">第 ${currentLevelData.targetN} 个</span> 格子里的<span class="value-keyword">盒子</span>，它在 <span class="keyword">下标 ${correctIdx}</span> (盒子数字是 <span class="value-keyword">${array[correctIdx]}</span>)。`;
                if (arrayDisplay.children[correctIdx]) { correctDOMElementToHighlight = arrayDisplay.children[correctIdx].querySelector('.value-box'); }
            } else if (taskType === 'findNthElement_clickIndex') {
                const correctIdx = currentLevelData.correctIndexForTask;
                correct = (clickedType === 'index' && itemIndex === correctIdx);
                userClickDescription = `你点击了 <span class="keyword">下标 ${itemIndex}</span>。`;
                 if (clickedType === 'element') { userClickDescription = `你点击了<span class="value-keyword">盒子</span> (位于<span class="keyword">下标 ${itemIndex}</span>)，但题目要求点击<span class="keyword">下标标签</span>。`; }
                correctTargetDescription = `要找的是 <span class="keyword">第 ${currentLevelData.targetN} 个</span> 格子对应的 <span class="keyword">下标标签</span>，也就是 <span class="keyword">下标 ${correctIdx}</span>。`;
                if (arrayDisplay.children[correctIdx]) { correctDOMElementToHighlight = arrayDisplay.children[correctIdx].querySelector('.index-label'); }
            }

            if (correct) {
                gameActive = false;
                feedbackArea.innerHTML = '🎉 太棒了！完全正确！ 🎉';
                feedbackArea.className = 'correct-feedback';
                clickedElement.classList.add('highlight-correct');
                if (taskType.includes('_clickElement')) {
                     setTimeout(() => { if (clickedElement) clickedElement.classList.add('eaten'); }, 300);
                }

                const randomColors = confettiColorsList[Math.floor(Math.random() * confettiColorsList.length)];
                const clickOrigin = {
                    x: event.clientX / window.innerWidth,
                    y: event.clientY / window.innerHeight
                };

                confetti({
                    particleCount: 150,
                    spread: 120,
                    startVelocity: 60,
                    decay: 0.9,
                    shapes: ['circle', 'square'],
                    origin: clickOrigin,
                    colors: randomColors
                });

                setTimeout(() => {
                    if (currentLevelIndex < levelTemplates.length - 1) {
                        currentLevelIndex++;
                        loadLevel(currentLevelIndex);
                    } else {
                        feedbackArea.innerHTML = '🏆 所有挑战完成！你太厉害了！ 🏆';
                        setTimeout(showWinModal, 500);
                    }
                }, 1800);

            } else { 
                feedbackArea.innerHTML = '🤔 噢哦，好像不对...再仔细看看！';
                feedbackArea.className = 'incorrect-feedback';
                clickedElement.classList.add('highlight-error-attempt');
                guidanceArea.innerHTML = `<strong>小提示：</strong>${userClickDescription}<br>${correctTargetDescription}`;
                setTimeout(() => guidanceArea.classList.add('visible'), 200);
                if (correctDOMElementToHighlight && correctDOMElementToHighlight !== clickedElement) {
                    setTimeout(() => { correctDOMElementToHighlight.classList.add('highlight-correct'); }, 700);
                }
            }
        }

        function createConfetti() {
            confettiCanvas.innerHTML = '';
            const colors = ['#4db6ac', '#ffab91', '#81c784', '#ffb74d', '#90caf9', '#fff176', '#ba68c8'];
            for (let i = 0; i < 100; i++) {
                const confetto = document.createElement('div');
                confetto.classList.add('confetto');
                confetto.style.left = Math.random() * 100 + 'vw';
                confetto.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetto.style.width = (Math.random() * 8 + 5) + 'px';
                confetto.style.height = confetto.style.width;
                confetto.style.animationDelay = Math.random() * 2 + 's';
                confetto.style.animationDuration = (Math.random() * 3 + 2) + 's';
                if(Math.random() > 0.5) confetto.style.borderRadius = '50%';
                confettiCanvas.appendChild(confetto);
            }
        }

        function showWinModal() {
            questionArea.innerHTML = '🎉 你是数组大师！ 🎉';
            winModal.style.display = 'flex';
            createConfetti();
        }

        function closeWinModal() {
            winModal.style.display = 'none';
            confettiCanvas.innerHTML = '';
        }

        guidanceArea.addEventListener('click', () => {
            guidanceArea.classList.remove('visible');
        });

        loadLevel(currentLevelIndex);
    </script>
</body>
</html>